# ğŸ“¦ GitHub Actions Workflow: Build and Deploy with Manual or Auto Trigger
# ------------------------------------------------------------------------------
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ë©€í‹° ëª¨ë“ˆ Spring Boot í”„ë¡œì íŠ¸ì—ì„œ ê° ëª¨ë“ˆì„ ê°œë³„ì ìœ¼ë¡œ ë¹Œë“œí•˜ê³ ,
# í™˜ê²½(dev ë˜ëŠ” prod)ì— ë”°ë¼ ì›ê²© ì„œë²„ë¡œ JAR íŒŒì¼ì„ ë°°í¬í•©ë‹ˆë‹¤.
# ìˆ˜ë™ ì‹¤í–‰(workflow_dispatch) ì‹œ ë°°í¬ í™˜ê²½ê³¼ ëª¨ë“ˆì„ ì„ íƒí•  ìˆ˜ ìˆìœ¼ë©°,
# master ë¸Œëœì¹˜ì—ì„œëŠ” ìë™ìœ¼ë¡œ ë¹Œë“œì™€ ë°°í¬ê¹Œì§€ ìˆ˜í–‰ë©ë‹ˆë‹¤.

name: Build and Deploy

# ------------------------------------------------------------------------------
# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches:
      - master                      # master ë¸Œëœì¹˜ì— push ì‹œ ìë™ ì‹¤í–‰ë¨ (CI/CD)
      - develop                     # develop ë¸Œëœì¹˜ì— push ì‹œë„ ê°€ëŠ¥í•˜ì§€ë§Œ ìˆ˜ë™ ë°°í¬ ê¶Œì¥
    paths:
       - 'bizcof-wms-app/**'             # ì•± ëª¨ë“ˆ ì „ì²´
       - 'bizcof-wms-api/**'             # API ëª¨ë“ˆ ì „ì²´
       - 'bizcof-common-core/**'         # ê³µí†µ ì½”ì–´ ëª¨ë“ˆ ì „ì²´
       - '.github/workflows/github-pipeline.yml'  # íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • ì‹œì—ë„ íŠ¸ë¦¬ê±°
  workflow_dispatch:               # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì…ë ¥ê°’ ì •ì˜
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ (dev ë˜ëŠ” prod)'
        required: true
        default: 'dev'             # ê¸°ë³¸ê°’ì€ dev í™˜ê²½ìœ¼ë¡œ ì„¤ì •
      module:
        description: 'ë°°í¬í•  ëª¨ë“ˆëª… (ì˜ˆ: bizcof-wms-app ë˜ëŠ” bizcof-mes-app)'
        required: true
        default: 'bizcof-wms-app'  # ê¸°ë³¸ ëŒ€ìƒ ëª¨ë“ˆ ì„¤ì •

# ------------------------------------------------------------------------------
# ì „ì—­ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (jobs ê³µí†µ)
env:
  JAVA_VERSION: '17'                            # Java 17 ì‚¬ìš©
  JAVA_DISTRIBUTION: 'temurin'                  # Adoptium Temurin JDK ì‚¬ìš©
  TARGET_SERVER_IP_DEV: 180.69.179.62           # ê°œë°œ í™˜ê²½ ëŒ€ìƒ ì„œë²„ì˜ ê³µì¸ IP
  TARGET_SERVER_IP_PROD: 180.69.179.62           # ìš´ì˜ í™˜ê²½ ëŒ€ìƒ ì„œë²„ì˜ IP
  REMOTE_USER: root                             # ë°°í¬í•  ë•Œ ì‚¬ìš©í•  SSH ìœ ì €ëª…

jobs:
  # ------------------------
  # âœ… ë¹Œë“œ Job ì •ì˜
  # ------------------------
  build:
    runs-on: ubuntu-latest                      # GitHubì—ì„œ ì œê³µí•˜ëŠ” Ubuntu ì‹¤í–‰í™˜ê²½ ì‚¬ìš©
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    env:
      MODULE_NAME: ${{ github.event.inputs.module || 'bizcof-wms-app' }}  # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì…ë ¥ê°’, ì•„ë‹ˆë©´ ê¸°ë³¸ê°’
    steps:
      - uses: actions/checkout@v3               # GitHub ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ í˜„ì¬ í™˜ê²½ì— ì²´í¬ì•„ì›ƒ

      - name: Set up Java                       # Java ê°œë°œ í™˜ê²½ êµ¬ì„±
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}  # Temurin JDK ì„¤ì¹˜
          java-version: ${{ env.JAVA_VERSION }}        # Java 17 ì„¤ì¹˜

      - name: Build the module with Gradle      # Gradle ëª…ë ¹ì–´ë¡œ ëª¨ë“ˆ ë¹Œë“œ ì‹¤í–‰
        run: |
          ./gradlew :${MODULE_NAME}:clean :${MODULE_NAME}:build -x test  # í…ŒìŠ¤íŠ¸ ì œì™¸í•˜ê³  ë¹Œë“œ
          ls -la ${MODULE_NAME}/build/libs                             # ë¹Œë“œëœ JAR íŒŒì¼ ëª©ë¡ ì¶œë ¥

      - name: Upload JAR artifact to GitHub     # ë¹Œë“œëœ JAR íŒŒì¼ì„ GitHub Actions Artifactë¡œ ì €ì¥ (ë‚˜ì¤‘ì— ë‹¤ìš´ë¡œë“œìš©)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.MODULE_NAME }}-jar
          path: ${{ env.MODULE_NAME }}/build/libs/*.jar                # JAR íŒŒì¼ ê²½ë¡œ

  # ------------------------
  # âœ… ë°°í¬ Job ì •ì˜
  # ------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build                                # build jobì´ ì™„ë£Œë˜ì–´ì•¼ ì‹¤í–‰ë¨
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    env:
      MODULE_NAME: ${{ github.event.inputs.module || 'bizcof-wms-app' }}
      ENV_PROFILE: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v3               # (í•„ìš” ì‹œ) ë ˆí¬ì§€í† ë¦¬ ì ‘ê·¼ìš© ì²´í¬ì•„ì›ƒ

      - name: Download built artifact           # build jobì—ì„œ ì—…ë¡œë“œí•œ JAR íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.MODULE_NAME }}-jar
          path: ./artifact                      # JAR íŒŒì¼ì„ ì €ì¥í•  ë¡œì»¬ ê²½ë¡œ ì§€ì •

      - name: Set JAR path                      # ë‹¤ìš´ë¡œë“œëœ JAR íŒŒì¼ ê²½ë¡œë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
        run: |
          JAR_PATH=$(find ./artifact -name "${MODULE_NAME}-*.jar" | head -n 1)
          if [ -z "$JAR_PATH" ]; then echo "JAR not found!"; exit 1; fi
          echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV

      - name: Determine server IP by profile    # í™˜ê²½ì— ë”°ë¼ ë°°í¬í•  ì„œë²„ IPë¥¼ ì„¤ì • (dev ë˜ëŠ” prod)
        run: |
          if [[ "$ENV_PROFILE" == "prod" ]]; then
            echo "SERVER_IP=$TARGET_SERVER_IP_PROD" >> $GITHUB_ENV
          else
            echo "SERVER_IP=$TARGET_SERVER_IP_DEV" >> $GITHUB_ENV
          fi

      - name: Deploy to Remote Server via SCP and SSH  # ì‹¤ì œ ë°°í¬ ë‹¨ê³„ (JAR ì „ì†¡ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘)
        env:
          PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # GitHub Secretì— ë“±ë¡ëœ ê°œì¸ SSH í‚¤
        run: |
          echo "$PRIVATE_KEY" > private_key.pem   # ê°œì¸í‚¤ ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
          chmod 600 private_key.pem                # SSH ë³´ì•ˆìƒ ê¶Œí•œ ì„¤ì • í•„ìˆ˜

          # ì›ê²© ì„œë²„ì— ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -o StrictHostKeyChecking=no -i private_key.pem $REMOTE_USER@$SERVER_IP \
            "mkdir -p /app/servers/${MODULE_NAME}"

          # SCPë¥¼ í†µí•´ JAR íŒŒì¼ ì „ì†¡
          scp -o StrictHostKeyChecking=no -i private_key.pem "$JAR_PATH" \
            $REMOTE_USER@$SERVER_IP:/app/servers/${MODULE_NAME}/

          # ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (systemd ë‹¨ìœ„ íŒŒì¼ì´ ì„œë²„ì— ì¡´ì¬í•´ì•¼ í•¨)
          ssh -o StrictHostKeyChecking=no -i private_key.pem $REMOTE_USER@$SERVER_IP \
            "sudo systemctl restart ${MODULE_NAME}.service"

          # ì¬ì‹œì‘ëœ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ (ì •ìƒ ë™ì‘ ì—¬ë¶€ í™•ì¸)
          ssh -o StrictHostKeyChecking=no -i private_key.pem $REMOTE_USER@$SERVER_IP \
            "sudo systemctl status ${MODULE_NAME}.service"
